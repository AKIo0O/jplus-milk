<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>J+ Library</title>
		<script src="../../system/core/assets/scripts/base.js" type="text/javascript"></script>
		<script src="../../system/dom/assets/scripts/base.js" type="text/javascript"></script>
		<script src="../../assets/demo/demo.js" type="text/javascript"></script>
	</head>
	<body>
		<script>
		    /**
             * 表示一个可以延时的操作。
             */
		    var DeferredTask = Class({
		        constructor: function () {
		            this._handlers = [];
		            Object.each(arguments, this.add, this);
		        },
                
		        add: function (deferrable, args) {
		            this._handlers.push([deferrable, args]);
		        },
                
                run: function (args) {
                    this.play();
                },
                
                abort: function () {
                    this.clear();
                    this._parent = null;
                },
                
                clear: function() {
                    if (this._current) {
                        this._current[0].abort();
                        this._current = null;
                    }
                    this._handlers.length = 0;
                    this.isPlaying = false;
                },
                
                play: function () {
                    if (this._current) return;
                    this.isPlaying = true;
                    this.next();
                },
                
                stop: function () {
                    this.clear();
                    if (this.onComplete) this.onComplete();
                    if (this._parent) {
                        this._parent.next();
                        this._parent = null;
                    }
                },
                
                next: function () {
                    if (this._handlers.length) {
                        var c = this._current = this._handlers.shift();
                        c[0]._parent = this;
                        c[0].run(c[1]);
                    } else {
                        this._current = null;
                        this.stop();
                    }
                }
		    });
            
            var Deferred = Class({
                constructor: function () {
                    this._task = new DeferredTask();
		        },
                
                start: function (args, link) {
                    switch (link) {
                        case "abort":
                            this._task.abort();
                            this._task.add(this, args);
                            this._task.play();
                            break;
                        case "stop":
                            this._task.stop();
                            this._task.add(this, args);
                            this._task.play();
                            break;
                        case "ignore":
                            if (!this._task.isPlaying) {
                                this._task.add(this, args);
                                this._task.play();
                            }
                            break;
                        default:
                            this._task.add(this, args);
                            this._task.play();
                            break;
                    }

                    return this;
                },
                
                then: function (callback, args) {
                    if (this === callback) {
                        return this.start(args);
                    }
                    var dable;
                    if (Function.isFunction(callback)) {
                        dable = {run: function (arg) {
                            callback.call(this, arg);
                            this._parent.next();
                        }, abort: function () {
                        }};
                    } else {
                        dable = callback;
                    }
                    this._task.add(dable, args);
                    this._task.play();
                },
                
                run: function (args) {
                },

                progress: function () {
                    if (this._parent) {
                        this._parent.next();
                    }
                },
                
                abort: function () {
                }
            });
            





		    var Fx = Deferred.extend({

		        onCallback: function(){
		            var me = this;
		            trace(me.options);
		            me.done();
		        },

		        run: function(options){
		            var me = this;
		            me.options = options;
		           me.resume();
		        },
				
				pause: function(){
		            var me = this;
					clearTimeout(me.timer);
				},
				
				resume: function(){
		            var me = this;
					 me.timer = setTimeout(me.onCallback.bind(me), 2000);
				},

				done: function () {
				    var me = this;
		            trace('fx  done');
					me.progress();
		        }

		    });
			
		    var fx = new Fx();


		    fx.start('1', 'wait');

		    fx.start('2', 'wait');

		    fx.then(function () {
		        trace('3');
            });

		    fx.then(fx, '4');

		    var fx2 = new Fx();

		   fx.then(fx2, '5');

		    fx2.start('6', 'wait');


			
		</script>
	</body>
</html>
