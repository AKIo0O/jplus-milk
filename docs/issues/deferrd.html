<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>J+ Library</title>
		<script src="../../system/core/assets/scripts/base.js" type="text/javascript"></script>
		<script src="../../system/dom/assets/scripts/base.js" type="text/javascript"></script>
		<script src="../../assets/demo/demo.js" type="text/javascript"></script>
	</head>
	<body>
		<script>




		    /**
 * 表示一个可以延时的操作。
 */
		    var Deferred = Class({

		        currentHandler: null,

		        constructor: function () {
		            this._handlers = [];
		            Object.each(arguments, this.add, this);
		        },

		        /**
	 *
	 * @param deferrable deferrable 是一个对象，该对象必须存在这些方法：
	 *		run - 执行当前函数。
	 *		abort - 禁止执行。
	 */
		        add: function (deferrable, args) {
		            this._handlers.push([deferrable, args]);
		        },

		        then: function (fn, args) {
		            if (this.isRunning) {
		                fn.call(this, args);
		            } else {
		                this.add({
		                    run: function (args, deferred) {
		                        fn.call(deferred, args);
		                        deferred.progress();
		                    },
		                    abort: Function.empty
		                }, args);
		            }
		        },

		        stop: function () {
		            this.pause();
		        },

		        abort: function () {
		            this.currentHandler = null;
		            if (this._handlers.length) {

		                if (this._handlers[0][0] !== this) {
		                    this._handlers[0][0].abort();
		                }

		                this._handlers.length = 0;
		            }
		            this.pause();
		        },

		        pause: function () {
		            clearTimeout(this.timer);
		        },

		        done: function () {
		            this.deferred.progress();
		        },

		        run: function (args, deferred) {
		            this.deferred = deferred;
		            this.timer = setTimeout(function () {
		                trace(args);
		                this.progress();
		            }.bind(this), 1000);
		        },

		        start: function (args) {
		            this.add(this, args);
		            if (!this.isRunning) {
		                this.progress();
		            }
		        },

		        progress: function () {
		            if (this._handlers.length) {
		                var nextHandler = this._handlers.shift();
		                this.currentHandler = nextHandler[0];
		                nextHandler[0].run(nextHandler[1], this);
		            } else {
		                if (this.deferred !== this) {
		                    this.done();
		                }
		                this.currentHandler = null;
		            }
		        }
		    });





		    var Fx = Class({

		        onCallback: function(){
		            trace(me.options);
		            me.done();
		        },

		        run: function(options){
		            var me = this;
		            me.options = options;
		            setTimeout(me.onCallback, 1000);
		        },

		        done: function(){
		            trace('fx  done');
		        }

		    });
			
		    var fx = new Fx();


		    fx.start('1', 'wait');

		    fx.start('2', 'wait');

		    fx.then(function () {
		        trace('3');
		    });


			
		</script>
	</body>
</html>
