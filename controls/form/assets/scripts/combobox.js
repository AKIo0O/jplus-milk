/** * @author xuld */imports("Controls.Form.ListBox");using("Controls.Form.Picker");/** * 表示一个组合框。 * @class * @extends Picker * @example <pre> * var comboBox = new ComboBox(); * comboBox.menu.add("aaa"); * comboBox.menu.add("bbb"); * comboBox.menu.setSelectedIndex(0); * </pre>
 */var ComboBox = Picker.extend({		xtype: 'combobox',		// 悬停选中		_getHover: function(){		return this._hoverItem;	},		_setHover: function(item){		var clazz = 'x-' + this.dropDown.xtype + '-hover';				if(this._hoverItem){			this._hoverItem.removeClass(clazz);		}				this._hoverItem = item ? item.addClass(clazz) : null;			},		/**	 * 移动当前选中项的位置。	 */	_moveHover: function(delta){				// 如果菜单未显示。	    if(this.dropDownHidden()){	    		    	// 显示菜单。	    	this.showMenu();	    } else {	    		    	var item = this._hoverItem || this.selectedItem;	    		    	if(item){	    		item = item[delta > 0 ? 'next' : 'prev']();	    	}	    		    	if(!item){	    		item = this.dropDown.item(delta > 0 ? 0 : -1);	    	}	    		    	this._setHover(item);	    		    }	},		onSelect: function(item){		return this.trigger('select', item);	},		/**	 * 处理键盘事件。
	 */	onKeyDown: function(e){		switch(e.keyCode) {						// 上下			case 40:			case 38:							// 阻止默认事件。			    e.preventDefault();			    				this._moveHover(e.keyCode === 40 ? 1 : -1);			    			    break;			    			// 回车			case 13:			case 10:				var currentItem = this._getHover();				if(currentItem != null) {					this.selectItem(currentItem);					e.preventDefault();				}		}	},		/**	 * 当用户单击某一项时执行。	 */	onItemClick: function(item, e){				// 如果无法更改值，则直接忽略。		if(!this.getAttr('disabled') && !this.getAttr('readonly')) {						// 禁止事件。			e.preventDefault();							// 设置当前的选中项。			this.selectItem(item);					}			},		/**	 * 创建当前 Picker 的菜单。	 * @return {Control} 下拉菜单。	 * @protected virtual	 */	createDropDown: function(existDom){		return new ComboBox.DropDownMenu(existDom);	},		/**	 * 将当前文本的值同步到下拉菜单。	 */	updateDropDown: function(){		var item = this.dropDown.getItemByText(this.getText());		this._setHover(item);	},		updateText: function(item){				this.setText(item.getText());				// 如果是 dropDownList, 还需要更新 <select> 的值。		if(this.hiddenField){			this.inputField.setText(item.dataField().value || "");		}	},		removeChild: function(item){				// 尝试从当前子节点删除。		item.detach(this.node);				// 尝试删除菜单项。		this.dropDown.removeChild(item);	},		init: function (options) {				// 1. 处理 <select>				// 如果初始化的时候传入一个 <select> 则替换 <select>, 并拷贝相关数据。		if(this.node.tagName === 'SELECT') {			this.hiddenField = new Dom(this.node);						// 调用 create 重新生成 dom 。			this.node = Dom.parseNode(this.dropDownListTpl);						// 隐藏 <select> 为新的 dom。			this.hiddenField.hide();						// 让 listBox 拷贝 <select> 的成员。			this.copyItemsFromSelect(this.hiddenField);						this.dropDownList = this;					}				// 2. 初始化文本框				// 初始化文本框		this.base('init');				// 3. 初始化菜单				// 绑定下拉菜单的点击事件		this.dropDown			.itemOn('mouseover', this._setHover, this)			.itemOn('click', this.onItemClick, this);				// 4. 绑定事件				// // 设置默认值。
		// if(defaultSelectedItem) {
			// listBox.clear();
			// this.onSelectItem(defaultSelectedItem);	
		// }				// 监听键盘事件。		this.on('keydown', this.onKeyDown);				// IE6 Hack: keydown 无法监听到回车。		if(navigator.isIE6) {			this.on('keypress', this.onKeyDown);			}	},		/**	 * 模拟鼠标选择某一个项。	 */	selectItem: function (item) {		this.setSelectedItem(item);		return this.hideDropDown();	},		/**	 * 获取当前选中的项。如果不存在选中的项，则返回 null 。	 * @return {Control} 选中的项。	 */	getSelectedItem: function(){		return this.selectedItem;	},		/**	 * 设置当前选中的项。	 * @param {Control} item 选中的项。	 * @return this	 */	setSelectedItem: function(item){		if(this.onSelect(item) !== false) {			this.selectedItem = item;			this.updateText(item);		}		return this;	},		getSelectedIndex: function(){		return this.dropDown.indexOf(this.getSelectedItem());	},		setSelectedIndex: function(value){		return this.setSelectedItem(this.dropDown.item(value));	},		// value 支持		baseGetValue: function(item){		return item.value || '';	},		baseSetValue: function(item, value){		item.value = value;	},		/**	 * 获取当前组合框的值。	 */	getValue: function(){		var item = this.getSelectedItem();		return item ? this.baseGetValue(item) : null;	},		/**	 * 设置当前组合框的值。	 */	setValue: function(value){				if(this.dropDown.each(function(item){			if(this.baseGetValue(item) === value) {				this.setSelectedItem(item);				return false;			}		}, this) !== false){			this.setText(value);							// 如果是 dropDownList, 还需要更新 <select> 的值。			if(this.hiddenField){				this.inputField.setText(value);			}		}				return this;	}}).addEvents('select').defineMethods('dropDown', 'item indexOf each count add addAt removeAt');ComboBox.DropDownMenu = ListControl.extend({		xtype: "listbox"});